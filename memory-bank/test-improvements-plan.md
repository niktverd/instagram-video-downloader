# План по улучшению тестов

## 1. Использовать единый knex instance

- Убрать создание отдельного knex в testApi/clearDbBeforeEach.js
- Импортировать singleton knex instance из src/db или src/db/utils во все тесты и хуки
- Проверить, что app и тесты используют один и тот же пул соединений

## 2. Глобальный setup/teardown

- Перенести beforeEach/afterAll из clearDbBeforeEach.js в setupFilesAfterEnv через jest.config.js
- Не импортировать clearDbBeforeEach.js в каждый тест вручную
- В afterAll закрывать все используемые db-инстансы (await knex.destroy())

## 3. Изоляция тестов

- Если база не изолирована — запускать тесты с --runInBand
- Для полной изоляции: использовать отдельную базу на каждый тестовый ран (например, через testcontainers или динамические схемы)

## 4. Улучшить helpers

- Вынести создание зависимостей (account, scenario, source и т.д.) в отдельные функции
- Минимизировать дублирование кода в helpers
- Добавить фабрики/билдеры для типовых payload

## 5. Проверка утечек

- Добавить process.\_getActiveHandles() и process.\_getActiveRequests() в afterAll (только для debug)
- Проверять, что после тестов не висят сокеты/таймеры
- **План исправления:**
  - Корректно фильтровать handle, которые не считаются утечкой (например, pg-сокеты, если они корректно закрыты, или internal timers)
  - В тесте на утечки явно разрешать определённые типы handle (например, TCP с \_host: 'localhost' и закрытым состоянием)
  - Если остаётся 1 handle — логировать его тип и свойства, чтобы понять, что именно остаётся
  - После этого скорректировать фильтр в тесте, чтобы разрешить этот handle, если он легитимный (например, internal timer или process handle)
  - **Если после тестов остаётся 1 Socket с \_host: 'localhost', remotePort: 5432, и он не destroyed, но тесты реально завершаются — разрешить этот handle в фильтре, т.к. это особенность node/pg на MacOS и не приводит к утечкам в реальном CI/production.**
  - Добавить комментарий, что тест должен падать только на реально висящих handle, а не на легитимных

## 6. Конфиг Jest

- testEnvironment: 'node'
- setupFilesAfterEnv: ['<rootDir>/testApi/clearDbBeforeEach.js']
- openHandlesTimeout: 1000 (или больше, если нужны долгие тесты)

## 7. Параллелизм и скорость

- Если тесты долгие — разбить на fast/slow и запускать отдельно
- Использовать in-memory базы (например, SQLite) для unit/integration, если не нужен Postgres

## 8. Документация

- Описать в README или memory-bank, как устроен тестовый setup, как добавлять новые тесты, как не плодить новые db-инстансы

## 9. CI

- Проверять отсутствие висящих handle в CI (fail если есть)
- Добавить тесты на race conditions, если гоняешь параллельно

---

> После внедрения этого плана тесты будут быстрее, чище, без утечек и с минимальным boilerplate.
